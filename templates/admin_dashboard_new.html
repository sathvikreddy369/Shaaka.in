{% extends "base.html" %}

{% block title %}Admin Dashboard - Shaaka{% endblock %}

{% block extra_css %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        color: white;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .section-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        color: #666;
        border: none;
        border-bottom: 3px solid transparent;
    }
    
    .nav-tabs .nav-link.active {
        color: #28a745;
        border-bottom: 3px solid #28a745;
        background: none;
    }
    
    .table-img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 5px;
    }
    
    .action-btn {
        padding: 5px 10px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="admin-header">
        <h2><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>
        <p class="mb-0">Welcome, {{ session.admin_username }}! Manage your platform from here.</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <i class="bi bi-people stats-icon text-primary"></i>
                <div class="stats-number">{{ customer_count }}</div>
                <div class="text-muted">Total Customers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="bi bi-tree stats-icon text-success"></i>
                <div class="stats-number">{{ farmer_count }}</div>
                <div class="text-muted">Total Farmers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="bi bi-basket stats-icon text-warning"></i>
                <div class="stats-number">{{ crop_count }}</div>
                <div class="text-muted">Total Products</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="bi bi-journal-text stats-icon text-info"></i>
                <div class="stats-number">{{ recipe_count }}</div>
                <div class="text-muted">Total Recipes</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Tabs -->
    <div class="section-card">
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#farmers">
                    <i class="bi bi-tree"></i> Farmers
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#products">
                    <i class="bi bi-basket"></i> Products
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#customers">
                    <i class="bi bi-people"></i> Customers
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#recipes">
                    <i class="bi bi-journal-text"></i> Recipes
                </a>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Farmers Tab -->
            <div class="tab-pane fade show active" id="farmers">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchFarmers" 
                           placeholder="Search farmers by name, phone, or location...">
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="farmersTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Location</th>
                                <th>Age</th>
                                <th>Products</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for farmer in farmers %}
                            <tr>
                                <td>{{ farmer.id }}</td>
                                <td>{{ farmer.name }}</td>
                                <td>{{ farmer.phone }}</td>
                                <td>{{ farmer.location }}</td>
                                <td>{{ farmer.age }}</td>
                                <td>
                                    <span class="badge bg-success">{{ farmer.product_count }} products</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary action-btn" 
                                            onclick="viewFarmerDetails({{ farmer.id }})">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-warning action-btn" 
                                            onclick="editFarmer({{ farmer.id }})">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div class="tab-pane fade" id="products">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchProducts" 
                               placeholder="Search products...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterType">
                            <option value="">All Types</option>
                            <option value="Vegetable">Vegetables</option>
                            <option value="Fruit">Fruits</option>
                            <option value="Food Grains">Food Grains</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">All Status</option>
                            <option value="1">Available</option>
                            <option value="0">Unavailable</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Image</th>
                                <th>Product</th>
                                <th>Type</th>
                                <th>Farmer</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr data-type="{{ product.crop_type }}" data-status="{{ product.is_available }}">
                                <td>
                                    <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                         class="table-img" alt="{{ product.crop_name }}">
                                </td>
                                <td>
                                    <strong>{{ product.crop_name }}</strong>
                                    <div class="small text-muted">ID: {{ product.id }}</div>
                                </td>
                                <td><span class="badge bg-info">{{ product.crop_type }}</span></td>
                                <td>{{ product.farmer_name }}</td>
                                <td>₹{{ product.price_per_kg }}/kg</td>
                                <td>
                                    <span class="badge {% if product.quantity < 20 %}bg-danger{% elif product.quantity < 50 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ product.quantity }} kg
                                    </span>
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('admin_toggle_product', crop_id=product.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm {% if product.is_available %}btn-success{% else %}btn-secondary{% endif %} action-btn">
                                            {% if product.is_available %}Available{% else %}Unavailable{% endif %}
                                        </button>
                                    </form>
                                </td>
                                <td>
                                    <div class="text-warning small">
                                        {% for i in range(5) %}
                                            {% if i < (product.average_rating or 0)|int %}
                                                <i class="bi bi-star-fill"></i>
                                            {% else %}
                                                <i class="bi bi-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                        ({{ product.review_count or 0 }})
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary action-btn" 
                                            onclick="editProduct({{ product.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Customers Tab -->
            <div class="tab-pane fade" id="customers">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchCustomers" 
                           placeholder="Search customers...">
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="customersTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Location</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers %}
                            <tr>
                                <td>{{ customer.id }}</td>
                                <td>{{ customer.name }}</td>
                                <td>{{ customer.email }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.location }}</td>
                                <td>{{ customer.created_at.strftime('%Y-%m-%d') if customer.created_at else 'N/A' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary action-btn" 
                                            onclick="viewCustomerDetails({{ customer.id }})">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Recipes Tab -->
            <div class="tab-pane fade" id="recipes">
                <div class="mb-3">
                    <a href="{{ url_for('add_recipe') }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Add New Recipe
                    </a>
                </div>
                
                <div class="row g-4">
                    {% for recipe in recipes %}
                    <div class="col-md-4">
                        <div class="card h-100">
                            <img src="{{ url_for('static', filename='uploads/' + recipe.image) }}" 
                                 class="card-img-top" style="height: 200px; object-fit: cover;" 
                                 alt="{{ recipe.recipe_name }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ recipe.recipe_name }}</h5>
                                <p class="card-text small">
                                    <strong>Main Items:</strong> {{ recipe.main_items }}<br>
                                    <strong>Masala Cost:</strong> ₹{{ recipe.masala_cost }}
                                </p>
                                <button class="btn btn-sm btn-primary" 
                                        onclick="viewRecipe({{ recipe.id }})">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Farmer Modal -->
<div class="modal fade" id="viewFarmerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Farmer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>Name:</strong> <span id="farmerName"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Phone:</strong> <span id="farmerPhone"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Location:</strong> <span id="farmerLocation"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Age:</strong> <span id="farmerAge"></span>
                    </div>
                    <div class="col-md-12 mb-3">
                        <strong>Aadhar:</strong> <span id="farmerAadhar"></span>
                    </div>
                </div>
                <hr>
                <h6>Products</h6>
                <div id="farmerProducts"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Farmer Modal -->
<div class="modal fade" id="editFarmerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Farmer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFarmerForm">
                    <input type="hidden" id="editFarmerId">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" id="editFarmerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" name="phone" id="editFarmerPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" name="location" id="editFarmerLocation" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" name="age" id="editFarmerAge" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFarmer()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- View Customer Modal -->
<div class="modal fade" id="viewCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>Name:</strong> <span id="customerName"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Email:</strong> <span id="customerEmail"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Phone:</strong> <span id="customerPhone"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Location:</strong> <span id="customerLocation"></span>
                    </div>
                </div>
                <hr>
                <h6>Addresses</h6>
                <div id="customerAddresses" class="mb-3"></div>
                <hr>
                <h6>Recent Orders</h6>
                <div id="customerOrders"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" name="crop_name" id="editProductName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price (₹/kg)</label>
                        <input type="number" class="form-control" name="price_per_kg" id="editProductPrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity (kg)</label>
                        <input type="number" class="form-control" name="quantity" id="editProductQuantity" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount (%)</label>
                        <input type="number" class="form-control" name="discount" id="editProductDiscount" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editProductDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.getElementById('searchFarmers')?.addEventListener('input', function() {
    filterTable('farmersTable', this.value);
});

document.getElementById('searchProducts')?.addEventListener('input', function() {
    filterTable('productsTable', this.value);
});

document.getElementById('searchCustomers')?.addEventListener('input', function() {
    filterTable('customersTable', this.value);
});

// Filter products
document.getElementById('filterType')?.addEventListener('change', filterProducts);
document.getElementById('filterStatus')?.addEventListener('change', filterProducts);

function filterTable(tableId, searchTerm) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
    }
}

function filterProducts() {
    const type = document.getElementById('filterType').value;
    const status = document.getElementById('filterStatus').value;
    const rows = document.querySelectorAll('#productsTable tbody tr');
    
    rows.forEach(row => {
        const rowType = row.dataset.type;
        const rowStatus = row.dataset.status;
        
        const typeMatch = !type || rowType === type;
        const statusMatch = !status || rowStatus === status;
        
        row.style.display = (typeMatch && statusMatch) ? '' : 'none';
    });
}

// View Farmer Details
function viewFarmerDetails(id) {
    fetch(`/admin/farmer/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFarmerModal(data.farmer, data.products);
            } else {
                alert('Error loading farmer details');
            }
        });
}

function showFarmerModal(farmer, products) {
    const modal = new bootstrap.Modal(document.getElementById('viewFarmerModal'));
    document.getElementById('farmerName').textContent = farmer.name;
    document.getElementById('farmerPhone').textContent = farmer.phone;
    document.getElementById('farmerLocation').textContent = farmer.location;
    document.getElementById('farmerAge').textContent = farmer.age;
    document.getElementById('farmerAadhar').textContent = farmer.aadhar || 'N/A';
    
    // Show products
    const productsList = document.getElementById('farmerProducts');
    if (products.length > 0) {
        productsList.innerHTML = products.map(p => `
            <div class="border-bottom py-2">
                <strong>${p.crop_name}</strong> - ₹${p.price_per_kg}/kg - ${p.quantity}kg
            </div>
        `).join('');
    } else {
        productsList.innerHTML = '<p class="text-muted">No products yet</p>';
    }
    
    modal.show();
}

// Edit Farmer
function editFarmer(id) {
    fetch(`/admin/farmer/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditFarmerModal(data.farmer);
            }
        });
}

function showEditFarmerModal(farmer) {
    document.getElementById('editFarmerId').value = farmer.id;
    document.getElementById('editFarmerName').value = farmer.name;
    document.getElementById('editFarmerPhone').value = farmer.phone;
    document.getElementById('editFarmerLocation').value = farmer.location;
    document.getElementById('editFarmerAge').value = farmer.age;
    
    const modal = new bootstrap.Modal(document.getElementById('editFarmerModal'));
    modal.show();
}

function saveFarmer() {
    const id = document.getElementById('editFarmerId').value;
    const formData = new FormData(document.getElementById('editFarmerForm'));
    
    fetch(`/admin/farmer/${id}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

// Edit Product
function editProduct(id) {
    fetch(`/admin/product/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditProductModal(data.product);
            }
        });
}

function showEditProductModal(product) {
    document.getElementById('editProductId').value = product.id;
    document.getElementById('editProductName').value = product.crop_name;
    document.getElementById('editProductPrice').value = product.price_per_kg;
    document.getElementById('editProductQuantity').value = product.quantity;
    document.getElementById('editProductDiscount').value = product.discount || 0;
    document.getElementById('editProductDescription').value = product.description || '';
    
    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
    modal.show();
}

function saveProduct() {
    const id = document.getElementById('editProductId').value;
    const formData = new FormData(document.getElementById('editProductForm'));
    
    fetch(`/admin/product/${id}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

// View Customer Details
function viewCustomerDetails(id) {
    fetch(`/admin/customer/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCustomerModal(data.customer, data.addresses, data.orders);
            }
        });
}

function showCustomerModal(customer, addresses, orders) {
    const modal = new bootstrap.Modal(document.getElementById('viewCustomerModal'));
    document.getElementById('customerName').textContent = customer.name;
    document.getElementById('customerEmail').textContent = customer.email;
    document.getElementById('customerPhone').textContent = customer.phone;
    document.getElementById('customerLocation').textContent = customer.location;
    
    // Show addresses
    const addressList = document.getElementById('customerAddresses');
    if (addresses.length > 0) {
        addressList.innerHTML = addresses.map(a => `
            <div class="border-bottom py-2">
                <strong>${a.address_type}</strong><br>
                ${a.house_number}, ${a.area}, ${a.city} - ${a.pincode}
            </div>
        `).join('');
    } else {
        addressList.innerHTML = '<p class="text-muted">No addresses saved</p>';
    }
    
    // Show orders
    const ordersList = document.getElementById('customerOrders');
    if (orders.length > 0) {
        ordersList.innerHTML = orders.map(o => `
            <div class="border-bottom py-2">
                Order #${o.id} - ₹${o.total_cost} - ${o.status}
            </div>
        `).join('');
    } else {
        ordersList.innerHTML = '<p class="text-muted">No orders yet</p>';
    }
    
    modal.show();
}

function viewRecipe(id) {
    window.location.href = `/recipe/${id}`;
}
</script>
{% endblock %}
